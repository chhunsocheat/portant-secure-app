{% extends "base.html" %}

{% block content %}

<h1>Google Docs API</h1>


<h1>Notifiable Data Breaches Scheme</h1>
<ul>
    {% if not user %}
    <li>
        <a href="{{oauth_url}}">Authorize</a>
    </li>
    {% endif %}
    <li>
        <a href="https://developers.google.com/docs/api" target="_blank" rel="nofollow">Documentation</a>
    </li>
</ul>

{% if user %}
    {% if  user.respondForm|length <= 0 %}
        <h1>User has no form<hi />
    {% else %}
        <div class="form-group">
            <label for="document-title">Document Title</label>
            <input type="text" id="document-title" class="form-control" name="document-title"
                value="Document Title">
        </div>

        {% for form in user.respondForm %}
            <div style="margin: 20px 0px;" class="card">
                <div class="card-header">
                    {{form.respondArray[0].inputLabel}}
                    <input type="checkbox" id="{{form.formId}}" style="float: right; width: 20px; height: 20px;" onclick="handleCheckboxClick(this)">
                </div>
            </div>
        {% endfor %}
        <button type="submit" class="btn btn-primary" onclick="handleSubmit();">Create</button>

    {% endif %}

<div id="document-result"></div>
{% endif %}

<script>
    var checkBoxes = new Array;

    function handleCheckboxClick(element) {
        // fetch("/make-document", {
        //     method: "POST",
        //     headers: {
        //         'Content-Type': 'application/json'
        //     },
        //     body: JSON.stringify(data)
        // })
        
        
        if (checkBoxes.find(e => e == element.id)) {
            console.log("Removing");
            checkBoxes = checkBoxes.filter(e => e != element.id);
        } else {
            console.log("Adding");
            checkBoxes.push(element.id)
        }
        // console.log(element.id);
        // console.log(checkBoxes);
    }

    function handleSubmit() {
        event.preventDefault();

        // update this part so it retrieves all the selected forms and adds them together to submit to google drive
        // const form = $('#create-document-form');
        // form.css("display", "none");

        $("#document-result").html("Creating document...");

        // let data = {}
        // for ({ name, value } of form.serializeArray())
        //     data[name] = value;
        let data = [document.getElementById("document-title").value, checkBoxes];
        console.log(JSON.stringify(data));

        fetch("/make-document", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(json => {
                $("#document-result").html(`<a href="${json['url']}"" target="_blank" rel="nofollow">View Document</a>`);
            })
            .catch(console.log)
    }
</script>

{% endblock %}